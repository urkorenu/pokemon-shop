{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Sidebar: User List -->
        <div class="col-md-4 border-end">
            <h4>{{ _('Chats') }}</h4>
            <div class="mb-3">
                <input type="text" id="user-search" class="form-control" placeholder="{{ _('Search users...') }}">
            </div>
            <ul id="user-list" class="list-group">
                {% for user in other_users %}
                <li class="list-group-item">
                    <a href="?new_user={{ user.id }}" class="text-decoration-none">{{ user.username }}</a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Main Chat Window -->
        <div class="col-md-8">
            {% if receiver %}
            <h4 class="text-center mb-3">{{ _('Chat with') }} {{ receiver.username }}</h4>
            <div id="chat-box" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: scroll;">
                {% for msg in messages %}
                <div class="{{ 'text-end' if msg.sender_id == current_user.id else 'text-start' }} mb-2">
                    <span class="badge {{ 'bg-primary' if msg.sender_id == current_user.id else 'bg-secondary' }}">
                        {{ msg.sender_username }}: {{ msg.message }}
                    </span>
                </div>
                {% endfor %}
            </div>
            <div class="input-group">
                <input type="text" id="message-input" class="form-control" placeholder="{{ _('Type your message...') }}">
                <button class="btn btn-success" onclick="sendMessage()">{{ _('Send') }}</button>
            </div>
            {% else %}
            <p class="text-center">{{ _('Select a user to start chatting.') }}</p>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io("https://www.pika-card.store", {
        transports: ["websocket", "polling"],
    });

    const room = "{{ receiver.id }}";

    // Join the chat room
    socket.emit("join_room", { receiver_id: room });

    socket.on("load_messages", (data) => {
	const chatBox = document.getElementById("chat-box");
	chatBox.innerHTML = "";  // Clear the chat box
	data.messages.forEach((msg) => {
	    const div = document.createElement("div");
	    div.textContent = `${msg.username}: ${msg.message}`;
	    chatBox.appendChild(div);
	});
    });

    socket.on("receive_message", (data) => {
	const chatBox = document.getElementById("chat-box");
	const div = document.createElement("div");
	div.textContent = `${data.username}: ${data.message}`;
	chatBox.appendChild(div);
	chatBox.scrollTop = chatBox.scrollHeight;  // Auto-scroll to the bottom
    });


    function sendMessage() {
        const messageInput = document.getElementById("message-input");
        const message = messageInput.value.trim();
        if (message) {
            socket.emit("send_message", { receiver_id: room, message });
            messageInput.value = "";
        }
    }
</script>
{% endblock %}

