{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Sidebar: User List -->
        <div class="col-md-4 border-end">
            <h4>{{ _('Chats') }}</h4>
            <div class="mb-3">
                <input type="text" id="user-search" class="form-control" placeholder="{{ _('Search users...') }}">
            </div>
            <ul id="user-list" class="list-group">
                {% for user in other_users %}
                <li class="list-group-item">
                    <a href="?new_user={{ user.id }}" class="text-decoration-none">{{ user.username }}</a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Main Chat Window -->
        <div class="col-md-8">
            {% if receiver %}
            <h4 class="text-center mb-3">{{ _('Chat with') }} {{ receiver.username }}</h4>
            <div id="chat-box" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: scroll;">
                {% for msg in messages %}
                    {% if msg.sender_id == current_user.id %}
                        <div class="text-end mb-2">
                            <span class="badge bg-primary">{{ _('You') }}: {{ msg.message }}</span>
                        </div>
                    {% else %}
                        <div class="text-start mb-2">
                            <span class="badge bg-secondary">{{ receiver.username }}: {{ msg.message }}</span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="input-group">
                <input type="text" id="message-input" class="form-control" placeholder="{{ _('Type your message...') }}">
                <button class="btn btn-success" onclick="sendMessage()">{{ _('Send') }}</button>
            </div>
            {% else %}
            <p class="text-center">{{ _('Select a user to start chatting.') }}</p>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io({
        transports: ['polling', "websocket"],
	upgrade: true,
	withCredentials: false
    });
    socket.emit("join_room"); // Join the user's room

    // Handle receiving messages
    socket.on("receive_message", (data) => {
        const chatBox = document.getElementById("chat-box");
        const alignment = data.sender_id == "{{ current_user.id }}" ? "text-end" : "text-start";
        const sender = data.sender_id == "{{ current_user.id }}" ? "{{ _('You') }}" : "{{ receiver.username }}";
        chatBox.innerHTML += `
            <div class="${alignment} mb-2">
                <span class="badge bg-${data.sender_id == "{{ current_user.id }}" ? 'primary' : 'secondary'}">
                    ${sender}: ${data.message}
                </span>
            </div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Send a message
    function sendMessage() {
        const messageInput = document.getElementById("message-input");
        const message = messageInput.value.trim();
        if (message) {
	    console.log("Sending message:", message, "to receiver:", "{{ receiver.id }}");
            socket.emit("send_message", {
                message: message,
                receiver_id: "{{ receiver.id }}"
            });
            messageInput.value = "";
        }
    }

    // User search functionality
    document.getElementById("user-search").addEventListener("input", function () {
        const query = this.value.toLowerCase();
        document.querySelectorAll("#user-list li").forEach(item => {
            item.style.display = item.textContent.toLowerCase().includes(query) ? "" : "none";
        });
    });
    socket.on("connect", () => {
	console.log("Socket.IO connected successfully with ID:", socket.id);
    });

    socket.on("disconnect", () => {
	console.log("Socket.IO disconnected");
    });

    socket.on("connect_error", (error) => {
	console.error("Connection Error:", error);
    });
</script>
{% endblock %}

